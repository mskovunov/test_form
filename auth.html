<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Firebase</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N0T0138X0Q');
    </script>
</head>
<body>
    <div class="container">
        
        <button class="menu-button" onclick="toggleMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <div class="form-wrapper">

            <div class="side-menu" id="sideMenu">
                <button class="close-button" onclick="toggleMenu()">‚ùå</button>
                <ul>
                    <li><a href="index.html">üè† –ì–æ–ª–æ–≤–Ω–∞</a></li> 
                    <li><a href="history.html">üìú –Ü—Å—Ç–æ—Ä—ñ—è</a></li> 
                    <li><a href="stats.html">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
                    <li><a href="settings.html">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
                    <li><a href="#" onclick="handleExit()">üö™ –í–∏—Ö—ñ–¥</a></li>
                </ul>
                <button type="button" class="theme-toggle" onclick="toggleTheme()">üåì –ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É</button>
            </div>
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
            
            <div id="auth-ui">
                <p id="loading-status" style="text-align: center; margin-bottom: 20px;"></p>
                
                <div id="auth-tabs" style="display: none;">
    
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="switchTab('login')">–í—Ö—ñ–¥</button>
                            <button class="tab-button" onclick="switchTab('signup')">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                        </div>
                        
                        <div id="login-tab-content" class="tab-content active">
                            
                            <label for="username-login-input">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</label>
                            <input type="text" id="username-login-input" placeholder="–í–∞—à –ª–æ–≥—ñ–Ω" autocomplete="username">
                            
                            <label for="password-input" style="margin-top: 15px; display: block;">–ü–∞—Ä–æ–ª—å:</label>
                            <input type="password" id="password-input" placeholder="********" autocomplete="current-password">
                            
                            <div style="margin-top: 25px;">
                                <button id="login-button" class="action-button primary-button">–£–≤—ñ–π—Ç–∏</button>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button id="google-login-button" class="action-button google-button">
                                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 10px; vertical-align: middle;">
                                        <path fill="#4285F4" d="M22.01 12.01c0-.7-.06-1.37-.16-2.01H12v3.78h5.38c-.23 1.15-.9 2.14-1.92 2.82v2.46h3.17c1.86-1.72 2.98-4.25 2.98-7.05z"/>
                                        <path fill="#34A853" d="M12 22c3.2 0 5.86-1.07 7.82-2.91l-3.17-2.46c-1.04.7-2.38 1.12-3.65 1.12-2.7 0-5-1.81-5.83-4.24H3.06v2.54c1.9 3.8 5.7 6.65 8.94 6.65z"/>
                                        <path fill="#FBBC05" d="M6.17 14.15c-.24-.7-.38-1.44-.38-2.15s.14-1.45.38-2.15V7.46H3.06c-.84 1.68-1.32 3.61-1.32 5.54s.48 3.86 1.32 5.54L6.17 14.15z"/>
                                        <path fill="#EA4335" d="M12 5.86c1.87 0 3.52.65 4.8 1.83l2.81-2.81C17.8 2.5 15.2 1.5 12 1.5c-3.2 0-7.01 2.85-8.91 6.66L6.17 9.85C7 7.42 9.3 5.86 12 5.86z"/>
                                        <path fill="none" d="M0 0h24v24H0z"/>
                                    </svg>
                                    –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                                </button>
                            </div>
                        </div>
                        
                        <div id="signup-tab-content" class="tab-content">
                            
                            <label for="signup-email-input">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞:</label>
                            <input type="email" id="signup-email-input" placeholder="example@domain.com" autocomplete="email">
                            
                            <label for="signup-username-input" style="margin-top: 15px; display: block;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</label>
                            <input type="text" id="signup-username-input" placeholder="–í–∞—à –ª–æ–≥—ñ–Ω" autocomplete="username">
                            
                            <label for="signup-password-input" style="margin-top: 15px; display: block;">–ü–∞—Ä–æ–ª—å:</label>
                            <input type="password" id="signup-password-input" placeholder="********" autocomplete="new-password">
                            
                            <div style="margin-top: 25px;">
                                <button id="signup-button" class="action-button primary-button">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                            </div>
                        </div>

                    </div>
                
                    <div id="auth-status" class="status-message" style="margin-top: 20px; display: none;"></div>
                </div>
                
                <div id="logged-in-message" style="display: none; text-align: center; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <h3>‚úÖ –í–∏ –≤–∂–µ —É–≤—ñ–π—à–ª–∏ —è–∫: <span id="user-email-display"></span></h3>
                    <p>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É...</p>
                    <button id="logout-button" class="action-button" style="margin-top: 15px;">–í–∏–π—Ç–∏</button>
                </div>
            </div>

            <p id="buildVersion" style="margin-top: 20px; font-size: 0.75rem; color: #999; text-align: center;"></p>
            
        </div>
    </div>
  
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="./firebase-init.js"></script>
    <script src="config.js"></script>    

  <script>
	    //const BUILD_VERSION = 'v2025.10.17.1600'; // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏
		
        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        
        function toggleMenu() {
            const menu = document.getElementById("sideMenu");
            menu.classList.toggle("open");
        }
        
        function closeWebView() {
            console.log("Attempting to close WebView...");
            if (typeof Android !== 'undefined' && Android.closeApp) {
                Android.closeApp();
            } else {
                console.warn("Native Android closeApp interface not found. Cannot close application.");
            }
        }
        
        async function handleLogout() {
            try {
                await auth.signOut();
                console.log("–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ Firebase.");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ Firebase:", error);
                alert("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: " + error.message);
            }
        }

        function handleExit() {
            handleLogout(); 
        }
        
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –ó–ê–ö–õ–ê–î–û–ö ---
        function switchTab(tabName) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.classList.remove('active');
                if (button.textContent.trim().toLowerCase().includes(tabName.toLowerCase())) {
                    button.classList.add('active');
                }
            });

            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab-content`) {
                    content.classList.add('active');
                }
            });
            
            document.getElementById('auth-status').style.display = 'none';
        }

        /* --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø USERNAME/EMAIL –í FIRESTORE --- */

        // 1. –ü–æ–∏—Å–∫ Email –≤ Firestore –ø–æ Username (–¥–ª—è –í–•–û–î–ê)
        async function findEmailByUsername(username) {
            const usersRef = db.collection('users');
            
            const snapshot = await usersRef.where('username', '==', username).limit(1).get();

            if (snapshot.empty) {
                return null; 
            }
            return snapshot.docs[0].data().email;
        }

        // 2. –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ü–ò–°–ò –î–ê–ù–ù–´–• –í FIRESTORE (–û–ë–ù–û–í–õ–ï–ù–û –î–õ–Ø USERNAME)
        async function saveUserData(user, username = null) {
            if (!user) return;
            const userRef = db.collection('users').doc(user.uid);
            
            const updateData = {
                email: user.email,
                lastSignInTime: firebase.firestore.FieldValue.serverTimestamp(),
            };
            
            if (username) {
                updateData.username = username; 
            }

            try {
                if (user.metadata && user.metadata.creationTime === user.metadata.lastSignInTime) {
                    updateData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
            } catch (e) {
                updateData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            await userRef.set(updateData, { merge: true })
            .then(() => {
                console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore.");
            })
            .catch((error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore:", error);
            });
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }
            
            if (typeof auth === 'undefined') {
                 document.getElementById('loading-status').innerHTML = '<p style="color: var(--status-error);">‚ùå –ü–æ–º–∏–ª–∫–∞: Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π.</p>';
                 return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
            const authTabs = document.getElementById('auth-tabs');
            const loggedInMessage = document.getElementById('logged-in-message');
            const userEmailDisplay = document.getElementById('user-email-display');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –í–•–û–î–ê
            const usernameLoginInput = document.getElementById('username-login-input'); 
            const passwordInput = document.getElementById('password-input');
            const loginButton = document.getElementById('login-button');
            const googleLoginButton = document.getElementById('google-login-button');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
            const signupEmailInput = document.getElementById('signup-email-input');
            const signupUsernameInput = document.getElementById('signup-username-input'); 
            const signupPasswordInput = document.getElementById('signup-password-input');
            const signupButton = document.getElementById('signup-button');

            const logoutButton = document.getElementById('logout-button');
            const authStatus = document.getElementById('auth-status');
            
            document.getElementById('loading-status').innerHTML = '<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</span>';
            
            
            // 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            auth.onAuthStateChanged((user) => {
                document.getElementById('loading-status').style.display = 'none';

                if (user) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                    userEmailDisplay.textContent = user.email;
                    authTabs.style.display = 'none'; 
                    loggedInMessage.style.display = 'block';
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        window.location.href = 'index.html'; 
                    }, 3000);

                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –Ω–µ –≤–æ—à–µ–ª
                    authTabs.style.display = 'block'; 
                    loggedInMessage.style.display = 'none';
                    switchTab('login'); 
                }
            });

            // 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (Email + Username + –ü–∞—Ä–æ–ª—å)
            signupButton.addEventListener('click', async () => {
                const email = signupEmailInput.value; 
                const username = signupUsernameInput.value; 
                const password = signupPasswordInput.value;

                authStatus.style.display = 'block';
                authStatus.innerHTML = '<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...</span>';

                try {
                    if (!username || username.trim() === '') {
                        throw { code: 'auth/missing-username', message: '‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.' };
                    }
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await saveUserData(userCredential.user, username); 
                    
                    // –£–°–ü–ï–• –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥" 
                    authStatus.innerHTML = '‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –í–∞—à –ª–æ–≥—ñ–Ω.';
                    signupEmailInput.value = '';
                    signupUsernameInput.value = '';
                    signupPasswordInput.value = '';
                    
                    // –î–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º
                    setTimeout(() => {
                        switchTab('login');
                    }, 2000); 

                } catch (error) {
                    let errorMessage = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
                    
                    if (error.code === 'auth/missing-username') { 
                        errorMessage = error.message;
                    } else if (error.code === 'auth/missing-password') {
						errorMessage = '‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å.';
					} else if (error.code === 'auth/invalid-email') {
						errorMessage = '‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, user@domain.com).';
					} else if (error.code === 'auth/weak-password') {
						errorMessage = '‚ö†Ô∏è –ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤.';
					} else if (error.code === 'auth/email-already-in-use') {
						errorMessage = '‚ö†Ô∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ü—ñ—î—é –ø–æ—à—Ç–æ—é –≤–∂–µ —ñ—Å–Ω—É—î.';
					}
                    authStatus.innerHTML = `<p style="color: var(--status-error);">${errorMessage}</p>`;
                    console.error('Signup error:', error);
                }
            });

            // 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ (Username + –ü–∞—Ä–æ–ª—å)
            loginButton.addEventListener('click', async () => {
                const username = usernameLoginInput.value; 
                const password = passwordInput.value;

                authStatus.style.display = 'block';
                authStatus.innerHTML = '<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –í—Ö—ñ–¥...</span>';

                try {
                    const email = await findEmailByUsername(username);

                    if (!email) {
                        throw { code: 'auth/user-not-found', message: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π' };
                    }
                    
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    
                    await saveUserData(userCredential.user, username); 

                } catch (error) {
                    let errorMessage = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
                    
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || errorMessage.includes('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π')) {
                        errorMessage = '‚ö†Ô∏è –ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å.';
                    } else if (error.code === 'auth/missing-password') { 
                        errorMessage = '‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å.';
                    } else if (error.code === 'permission-denied') { // –Ø–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–∞–≤
                        errorMessage = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ü—Ä–∞–≤–∏–ª–∞ Firebase Firestore.';
                    }
                    
                    authStatus.innerHTML = `<p style="color: var(--status-error);">${errorMessage}</p>`;
                    console.error('Login error:', error);
                }
            });
            
            // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–∏–π—Ç–∏"
            logoutButton.addEventListener('click', handleLogout);
			
			// 5. –õ–æ–≥–∏–∫–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ Google
            googleLoginButton.addEventListener('click', async () => {
                
                authStatus.style.display = 'block';
                authStatus.innerHTML = '<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Google...</span>';
                
                const provider = new firebase.auth.GoogleAuthProvider();

                try {
                    const userCredential = await auth.signInWithPopup(provider);
                    
                    await saveUserData(userCredential.user);
                    
                } catch (error) {
                    let errorMessage = '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ Google.';

                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = '‚ö†Ô∏è –í—ñ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –±—É–ª–æ –∑–∞–∫—Ä–∏—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = '‚ö†Ô∏è –ó–∞–ø–∏—Ç –Ω–∞ –≤—Ö—ñ–¥ –±—É–ª–æ —Å–∫–∞—Å–æ–≤–∞–Ω–æ.';
                    } else {
                        errorMessage = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                    }

                    authStatus.innerHTML = `<p style="color: var(--status-error);">${errorMessage}</p>`;
                    console.error('Google Login error:', error);
                }
            });
			
		¬† document.getElementById('buildVersion').textContent = BUILD_VERSION; 	
        });

    </script>
</body>
</html>