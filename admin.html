<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N0T0138X0Q');
    </script>
</head>
<body>
    <div class="container">
        
        <button class="menu-button" onclick="toggleMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        
        <div class="form-wrapper">

            <div class="side-menu" id="sideMenu">
                <button class="close-button" onclick="toggleMenu()">‚ùå</button>
                <ul>
                    <li><a href="index.html">üè† –ì–æ–ª–æ–≤–Ω–∞</a></li> 
                    <li><a href="history.html">üìú –Ü—Å—Ç–æ—Ä—ñ—è</a></li> 
                    <li><a href="stats.html">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
                    <li><a href="settings.html">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
                    <li><a href="#" onclick="handleExit()">üö™ –í–∏—Ö—ñ–¥</a></li>
                </ul>
                <button type="button" class="theme-toggle" onclick="toggleTheme()">üåì –ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É</button>
            </div>


            <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

            <p id="admin-status" style="text-align: center; margin-bottom: 20px;"></p>

            <div id="log-table-container">
                </div>
            
            <p id="buildVersion" style="margin-top: 20px; font-size: 0.75rem; color: #999; text-align: center;"></p>
            
        </div>
    </div>
  
    <script src="config.js"></script>	
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="./firebase-init.js"></script>

    <script>
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    let isAdmin = false;

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ index.html) ---
    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    function toggleMenu() {
        const menu = document.getElementById("sideMenu");
        menu.classList.toggle("open");
    }
    
    async function handleLogout() {
        try {
            await auth.signOut();
            window.location.replace('auth.html'); 
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ Firebase:", error);
            alert("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: " + error.message);
        }
    }

    function handleExit() {
        handleLogout(); 
    }

    // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ---

    async function checkAdminStatus(user) {
        if (!user || typeof db === 'undefined') {
            window.location.replace('auth.html'); // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            return;
        }

        const userRef = db.collection('users').doc(user.uid);
        try {
            const doc = await userRef.get();
            const data = doc.data();
            
            if (doc.exists && data.role === 'admin') {
                isAdmin = true;
                // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
                loadPortLogs();
            } else {
                alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
                window.location.replace('index.html'); // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", error);
            alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞.');
            window.location.replace('index.html');
        }
    }

    // --- –ó–ê–ì–†–£–ó–ö–ê –ò –†–ï–ù–î–ï–†–ò–ù–ì –õ–û–ì–û–í ---

    async function loadPortLogs() {
        const logDiv = document.getElementById('log-table-container');
        const statusDiv = document.getElementById('admin-status');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤ –ø–æ—Ä—Ç—É...</span>`;
        statusDiv.style.display = 'block';

        try {
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            const logsRef = db.collection('port_logs');
            const snapshot = await logsRef.orderBy('timestamp', 'desc').limit(200).get(); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 200 –ª–æ–≥–æ–≤
            
            statusDiv.style.display = 'none';

            if (snapshot.empty) {
                logDiv.innerHTML = '<p style="text-align: center;">–õ–æ–≥–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–æ—Ä—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
            } else {
                const logData = snapshot.docs.map(doc => doc.data());
                renderLogTable(logData, logDiv);
            }
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:", error);
            statusDiv.innerHTML = `<p style="color: var(--status-error);">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ü—Ä–∞–≤–∏–ª–∞ Firestore.</p>`;
        }
    }

    function renderLogTable(data, container) {
        let html = `
            <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>–ß–∞—Å (–º—ñ—Å—Ü–µ–≤–∏–π)</th>
                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á (–ª–æ–≥—ñ–Ω)</th>
                            <th class="status-col">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.forEach(row => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π timestamp
            const timeValue = row.timestamp ? row.timestamp.toDate() : new Date(); 
            const localTimeString = row.localTime || timeValue.toLocaleDateString('uk-UA', { 
                day: '2-digit', month: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', 
                hour12: false 
            }).replace(',', ''); 
            
            const statusUA = row.statusUA || (row.status === 'busy' ? '–ó–∞–π–Ω—è—Ç–∏–π' : '–î–æ—Å—Ç—É–ø–Ω–∏–π');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å—ã –∏–∑ style.css
            const statusClass = row.status === 'busy' ? 'inactive' : 'active';
            const statusIcon = row.status === 'busy' ? 'üî¥' : 'üü¢';

            html += `
                <tr class="row-${statusClass}">
                    <td>${localTimeString}</td>
                    <td>${row.username || row.email || row.userId || '–ù–µ–≤—ñ–¥–æ–º–∏–π'}</td>
                    <td class="status-col">
                        <span class="status-indicator status-${statusClass}">
                            ${statusIcon} ${statusUA}
                        </span>
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.addEventListener('DOMContentLoaded', () => {
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark');
        }
        
        document.getElementById('buildVersion').textContent = BUILD_VERSION;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–æ–ª–∏
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkAdminStatus(user);
            } else {
                window.location.replace('auth.html'); // –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
            }
        });
    });
    </script>
</body>
</html>