<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-N0T0138X0Q");
    </script>
  </head>
  <body>
    <div class="container">
      <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é -->
      <button class="menu-button" onclick="toggleMenu()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4 6H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 12H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 18H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div class="form-wrapper">
        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –∑–∞—á–∏—Ç—ã–≤–∞–µ–º –∏–∑ utils.js-->
        <div id="sidebar-placeholder"></div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <h2>–°–∏—Å—Ç–µ–º–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>

        <!-- –ê–ö–ö–û–†–î–ï–û–ù 1: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
        <div class="accordion-item">
          <div
            class="accordion-header"
            id="configHeader"
            onclick="toggleAccordion('configContent')"
          >
            <span class="accordion-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content open" id="configContent">
            <div id="configTableContainer" style="text-align: left">
              <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ -->
            </div>
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ (–ü–ï–†–ï–ú–ï–©–ï–ù –ü–û–î –¢–ê–ë–õ–ò–¶–£) -->
            <div
              id="configStatus"
              class="status-message"
              style="text-align: center; margin-top: 20px"
            ></div>
          </div>
        </div>
        <!-- –ö–û–ù–ï–¶ –ê–ö–ö–û–†–î–ï–û–ù–ê 1 -->

        <!-- –ù–û–í–´–ô –ê–ö–ö–û–†–î–ï–û–ù 2: Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
        <div class="accordion-item">
          <div
            class="accordion-header"
            onclick="toggleAccordion('emailContent')"
          >
            <span class="accordion-title">Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <!-- –£–±—Ä–∞–Ω –∫–ª–∞—Å—Å 'open', —á—Ç–æ–±—ã –±–ª–æ–∫ –±—ã–ª —Å–≤–µ—Ä–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
          <div class="accordion-content" id="emailContent">
            <div id="emailListContainer">
              <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ email'–æ–≤ -->
              <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ JS -->
            </div>
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏. -->
            <div
              id="emailStatus"
              class="status-message"
              style="text-align: center; margin-top: 20px; display: none"
            ></div>
          </div>
        </div>
        <!-- –ö–û–ù–ï–¶ –ê–ö–ö–û–†–î–ï–û–ù–ê 2 -->

        <!-- –í–µ—Ä—Å–∏—è —Å–±–æ—Ä–∫–∏ -->
        <p
          id="buildVersion"
          style="
            margin-top: 20px;
            font-size: 0.75rem;
            color: #999;
            text-align: center;
          "
        ></p>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ü–ï–†–ï–î –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º -->
    <script src="config.js"></script>
    <script src="utils.js"></script>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      let appData = null;

      // –§–£–ù–ö–¶–ò–Ø: –ü–ª–∞–≤–Ω–æ–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ
      function toggleAccordion(contentId) {
        const content = document.getElementById(contentId);
        const header = content.previousElementSibling;
        const icon = header.querySelector(".accordion-icon");

        // –ï—Å–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å
        if (
          contentId === "configContent" &&
          content.classList.contains("open")
        ) {
          document.getElementById("configStatus").style.display = "none";
        }
        if (
          contentId === "emailContent" &&
          content.classList.contains("open")
        ) {
          document.getElementById("emailStatus").style.display = "none";
        }

        content.classList.toggle("open");
        header.classList.toggle("active");

        if (content.classList.contains("open")) {
          // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º max-height –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ + –ë–£–§–ï–†
          content.style.maxHeight = content.scrollHeight + 50 + "px";
          icon.innerHTML = "‚ñ≤";
        } else {
          // –°–≤–µ—Ä–Ω—É—Ç—å
          content.style.maxHeight = "0";
          icon.innerHTML = "‚ñº";
        }
      }

      /* --- –§–£–ù–ö–¶–ò–Ø: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ email --- */
      async function saveEmail(sheetRow, inputElement) {
        const newEmail = inputElement.value.trim();
        const statusDiv = document.getElementById("emailStatus");
        const originalBorder = inputElement.style.borderColor;

        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ email –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
        if (newEmail === inputElement.dataset.originalEmail) {
          return;
        }

        // –ù–û–í–û–ï: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(newEmail)) {
          statusDiv.innerHTML = `<p style="color: var(--status-error);">‚ö†Ô∏è –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∏.</p>`;
          statusDiv.style.display = "block";
          inputElement.style.border = "2px solid var(--status-error)";

          // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
          const content = document.getElementById("emailContent");
          if (content && content.classList.contains("open")) {
            content.style.maxHeight = content.scrollHeight + 50 + "px";
          }

          setTimeout(() => {
            statusDiv.style.display = "none";
            inputElement.style.borderColor = originalBorder;
          }, 3000);
          return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞
        }

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        inputElement.style.border = "2px solid orange";
        inputElement.disabled = true;

        statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –û–Ω–æ–≤–ª–µ–Ω–Ω—è email –¥–ª—è —Ä—è–¥–∫–∞ ${sheetRow}...</span>`;
        statusDiv.style.display = "block";

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç –≤—ã—Å–æ—Ç—ã –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
        const content = document.getElementById("emailContent");
        if (content && content.classList.contains("open")) {
          content.style.maxHeight = content.scrollHeight + 50 + "px";
        }

        try {
          const formData = new FormData();
          formData.append("updateConfig", "1");
          // –ì–ê–†–ê–ù–¢–ò–†–£–ï–ú, —á—Ç–æ row –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
          formData.append("row", String(sheetRow));
          formData.append("email", newEmail);
          // –ì–ê–†–ê–ù–¢–ò–†–£–ï–ú, —á—Ç–æ column –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
          formData.append("column", "4"); // –ö–æ–ª–æ–Ω–∫–∞ D (Email) –∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å 4 (A=1, B=2, C=3, D=4)

          const resp = await fetch(WEBAPP_URL, {
            method: "POST",
            body: formData,
          });

          const responseText = await resp.text();

          if (responseText.includes("Success")) {
            statusDiv.innerHTML = `‚úÖ Email –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ –Ω–∞: ${newEmail}`;
            inputElement.style.border = "2px solid var(--status-success)";
            inputElement.dataset.originalEmail = newEmail; // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª

            await loadConfig();
          } else {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Ç GAS, –æ–Ω–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞.
            throw new Error(responseText);
          }
        } catch (err) {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏, –≤–∫–ª—é—á–∞—è –æ—à–∏–±–∫—É 'Invalid input parameters' –æ—Ç GAS
          let errorMessage = err.message || "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞";

          if (errorMessage.includes("Error: Invalid input parameters")) {
            errorMessage =
              "–ü–æ–º–∏–ª–∫–∞: GAS –Ω–µ –ø—Ä–∏–π–Ω—è–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ GAS –ª–æ–≥—ñ–∫—É –∞–±–æ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.";
          } else if (errorMessage.includes("DOCTYPE")) {
            errorMessage = "–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –∑ GAS. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ URL –∞–±–æ –¥–æ–∑–≤–æ–ª–∏.";
          }

          statusDiv.innerHTML = `<p style="color: var(--status-error);">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è email: ${errorMessage}</p>`;
          inputElement.style.border = "2px solid var(--status-error)";
          console.error("–ü–æ–º–∏–ª–∫–∞ POST-–∑–∞–ø–∏—Ç—É:", err);
        }

        inputElement.disabled = false;

        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
        setTimeout(() => {
          statusDiv.style.display = "none";
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ü–≤–µ—Ç —Ä–∞–º–∫–∏
          inputElement.style.borderColor = originalBorder;

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
          if (content && content.classList.contains("open")) {
            content.style.maxHeight = content.scrollHeight + 50 + "px";
          }
        }, 3000);
      }

      /* --- –§–£–ù–ö–¶–ò–ò: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Email –∏ PUSH --- */

      // --- –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ 1) ---
      async function updateConfigStatus(
        sheetRow,
        currentFlag,
        targetColumn,
        event
      ) {
        // targetColumn: 5 –¥–ª—è Email (E) –∏–ª–∏ 6 –¥–ª—è PUSH (F)

        // ... (–ö–û–î –ê–ù–ê–õ–û–ì–ò–ß–ï–ù saveEmail, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç—É—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ) ...
        if (event.target.classList.contains("status-loading")) return;

        const statusDiv = document.getElementById("configStatus");
        const newStatus = currentFlag === "1" ? "0" : "1"; // –í–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ
        const indicator = event.target;
        const originalHTML = indicator.innerHTML;
        indicator.innerHTML = "üîÑ";
        indicator.classList.add("status-loading");
        // –í—ã–≤–æ–¥–∏–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —Ä—è–¥–∫–∞ ${sheetRow} —É –∫–æ–ª–æ–Ω—Ü—ñ ${targetColumn}...</span>`;
        statusDiv.style.display = "block";

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç –≤—ã—Å–æ—Ç—ã, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const content = document.getElementById("configContent");
        if (content && content.classList.contains("open")) {
          content.style.maxHeight = content.scrollHeight + 50 + "px";
        }

        try {
          const formData = new FormData();
          formData.append("updateConfig", "1");
          formData.append("row", sheetRow);
          formData.append("status", newStatus);
          formData.append("column", targetColumn);

          const resp = await fetch(WEBAPP_URL, {
            method: "POST",
            body: formData,
          });
          const responseText = await resp.text();

          if (responseText.includes("Success")) {
            // –í—ã–≤–æ–¥–∏–º —É—Å–ø–µ—Ö
            statusDiv.innerHTML = "‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ.";
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadConfig();
          } else {
            throw new Error(responseText);
          }
        } catch (err) {
          statusDiv.innerHTML = `<p style="color: var(--status-error);">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${
            err.message || "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞"
          }</p>`;
          console.error("–ü–æ–º–∏–ª–∫–∞ POST-–∑–∞–ø–∏—Ç—É:", err); // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º UI –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
          indicator.innerHTML = originalHTML;
          indicator.classList.remove("status-loading");
        } // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
        setTimeout(() => {
          statusDiv.style.display = "none";
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è —Å—Ç–∞—Ç—É—Å–∞
          if (content && content.classList.contains("open")) {
            content.style.maxHeight = content.scrollHeight + 50 + "px";
          }
        }, 3000);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ Email" (–ö–æ–ª–æ–Ω–∫–∞ E, –∏–Ω–¥–µ–∫—Å 5)
      async function toggleEmailStatus(sheetRow, currentFlag, event) {
        await updateConfigStatus(sheetRow, currentFlag, 5, event);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ "–û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ PUSH" (–ö–æ–ª–æ–Ω–∫–∞ F, –∏–Ω–¥–µ–∫—Å 6)
      async function togglePushStatus(sheetRow, currentFlag, event) {
        await updateConfigStatus(sheetRow, currentFlag, 6, event);
      }

      /* --- –§–£–ù–ö–¶–ò–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê EMAIL-–°–ü–ò–°–ö–ê (–î–û–ë–ê–í–õ–ï–ù–û –ü–û–õ–ï –í–í–û–î–ê) --- */

      // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã email-–∞–¥—Ä–µ—Å–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç user_a –∏ email
      function renderEmailListTable(data, container) {
        let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        data.forEach((row, index) => {
          // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ Google Sheet: index + 2 (—Ç.–∫. —á–∏—Ç–∞–µ–º —Å A2)
          const sheetRow = index + 2;

          html += `
                    <tr>
                        <td>${row.user_a}</td>
                        <td>
                            <input type="email" 
                                   class="email-input" 
                                   value="${row.email}"
                                   data-original-email="${row.email}"
                                   onblur="saveEmail(${sheetRow}, this)"
                                   onkeydown="if(event.key === 'Enter') { this.blur(); }">
                        </td>
                    </tr>
                `;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
      }

      // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ ---
      async function loadConfig() {
        const configDiv = document.getElementById("configTableContainer");
        const emailListDiv = document.getElementById("emailListContainer");
        const statusDiv = document.getElementById("configStatus");
        const emailStatusDiv = document.getElementById("emailStatus");

        // ... (–ö–û–î –ó–ê–ì–†–£–ó–ö–ò) ...

        // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ê–ö–ö–û–†–î–ï–û–ù–ê 1
        statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó...</span>`;
        statusDiv.style.display = "block";

        // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ê–ö–ö–û–†–î–ï–û–ù–ê 2
        emailListDiv.innerHTML = `
                <p style="text-align: center; color: var(--text-color);">
                    <span class="inline-spinner-wrapper"><span class="inline-spinner"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É email...</span>
                </p>`;

        // –ê–∫–∫–æ—Ä–¥–µ–æ–Ω 1
        const contentConfig = document.getElementById("configContent");
        if (contentConfig && contentConfig.classList.contains("open")) {
          contentConfig.style.maxHeight =
            contentConfig.scrollHeight + 50 + "px";
        }

        // –ê–∫–∫–æ—Ä–¥–µ–æ–Ω 2
        const contentEmail = document.getElementById("emailContent");
        if (contentEmail && contentEmail.classList.contains("open")) {
          contentEmail.style.maxHeight = contentEmail.scrollHeight + 50 + "px";
        }

        try {
          // –ó–∞–ø—Ä–æ—Å –∫ GAS –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
          const resp = await fetch(WEBAPP_URL + "?getConfig=1");
          const dataText = await resp.text(); // –û–∂–∏–¥–∞–µ–º TEXT –¥–ª—è CORS
          const data = JSON.parse(dataText);

          appData = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ

          if (!appData || appData.length === 0) {
            configDiv.innerHTML =
              "<p>–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ä–æ–∑—Å–∏–ª–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∞–±–æ –ø—É—Å—Ç–∞.</p>";
            emailListDiv.innerHTML =
              '<p style="text-align: center;">–°–ø–∏—Å–æ–∫ email\'—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
          } else {
            // –†–ï–ù–î–ï–†–ò–ù–ì –ê–ö–ö–û–†–î–ï–û–ù–ê 1
            renderConfigTable(appData, configDiv);

            // –†–ï–ù–î–ï–†–ò–ù–ì –ê–ö–ö–û–†–î–ï–û–ù–ê 2
            renderEmailListTable(appData, emailListDiv);

            // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω 1 –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(() => {
              if (contentConfig && contentConfig.classList.contains("open")) {
                contentConfig.style.maxHeight =
                  contentConfig.scrollHeight + 50 + "px";
                document.getElementById("configHeader").classList.add("active");
                document
                  .getElementById("configHeader")
                  .querySelector(".accordion-icon").innerHTML = "‚ñ≤";
              }
            }, 50);
          }

          // –°–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
          statusDiv.style.display = "none";

          // –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ email-–∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
          emailStatusDiv.style.display = "none";
        } catch (err) {
          // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤–Ω—É—Ç—Ä–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ 1
          statusDiv.innerHTML =
            '<p style="color: var(--status-error);">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ì–êS.</p>';
          configDiv.innerHTML = "";
          console.error("–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:", err);

          // –°–±—Ä–æ—Å –ª–æ–∞–¥–µ—Ä–∞ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ 2
          emailListDiv.innerHTML =
            '<p style="text-align: center; color: var(--status-error);">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É email.</p>';

          // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
          if (contentConfig && contentConfig.classList.contains("open")) {
            contentConfig.style.maxHeight =
              contentConfig.scrollHeight + 50 + "px";
          }
          if (contentEmail && contentEmail.classList.contains("open")) {
            contentEmail.style.maxHeight =
              contentEmail.scrollHeight + 50 + "px";
          }
        }
      }

      // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã ---
      function renderConfigTable(data, container) {
        let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <!-- <th>Email</th> -->
                            <th class="status-col">–û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ Email</th>
							<th class="status-col">–û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ PUSH</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        data.forEach((row, index) => {
          const isEmailActive = row.flag === "1";
          const isPushActive = row.flagP === "1";
          // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ Google Sheet: index + 2 (—Ç.–∫. —á–∏—Ç–∞–µ–º —Å A2)
          const sheetRow = index + 2;

          // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Email (–ö–æ–ª–æ–Ω–∫–∞ E)
          const emailIcon = isEmailActive ? "üü¢" : "üî¥";
          const emailClass = isEmailActive ? "active" : "inactive";

          // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Push (–ö–æ–ª–æ–Ω–∫–∞ F)
          const pushIcon = isPushActive ? "üü¢" : "üî¥";
          const pushClass = isPushActive ? "active" : "inactive";

          html += `
                     <tr class="row-${isEmailActive ? "active" : "inactive"}">
                        <td>${row.user_a}</td>
                        <!-- <td class="email-col">${row.email}</td> -->
                        <td class="status-col">
                            <span class="status-indicator status-${emailClass}" 
                                  onclick="toggleEmailStatus(${sheetRow}, '${
            row.flag
          }', event)">
                                ${emailIcon} ${isEmailActive ? "–¢–∞–∫" : "–ù—ñ"}
                            </span>
                        </td>
						<td class="status-col">
                            <span class="status-indicator status-${pushClass}" 
                                  onclick="togglePushStatus(${sheetRow}, '${
            row.flagP
          }', event)">
                                 ${pushIcon} ${isPushActive ? "–¢–∞–∫" : "–ù—ñ"}
                            </span>
                        </td>
                    </tr>
                `;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
      }

      // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
      window.addEventListener("DOMContentLoaded", async () => {
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark");
        }
        await loadComponent("sidebar-placeholder", "sidebar.html");
        loadConfig();
      });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="./firebase-init.js"></script>

    <script>
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      auth.onAuthStateChanged((user) => {
        if (!user) {
          // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
          console.log(
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞."
          );
          // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
          window.location.replace("auth.html");
        } else {
          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
          console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫:", user.email);
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firestore)
        }
      });

      // // (–í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ GAS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞)
    </script>
  </body>
</html>
