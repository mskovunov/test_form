<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Налаштування</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        
        <!-- Кнопка меню -->
        <button class="menu-button" onclick="toggleMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <div class="form-wrapper">

            <!-- Боковое меню (Убрано, чтобы избежать дублирования кода) -->
            <div class="side-menu" id="sideMenu">
                <button class="close-button" onclick="toggleMenu()">❌</button>
                <ul>
                    <li><a href="index.html">🏠 Головна</a></li> 
                    <li><a href="history.html">📜 Історія</a></li> 
                    <li><a href="stats.html">📈 Статистика</a></li>
                    <li><a href="settings.html">⚙️ Налаштування</a></li>
                    <li><a href="#" onclick="closeWebView()">🚪 Вихід</a></li>
                </ul>
                <button type="button" class="theme-toggle" onclick="toggleTheme()">🌓 Змінити тему</button>
            </div>


            <!-- Основное содержимое -->
            <h2>Системні налаштування</h2>

            <!-- АККОРДЕОН 1: Налаштування сповіщень користувачів -->
            <div class="accordion-item">
                <div class="accordion-header" id="configHeader" onclick="toggleAccordion('configContent')">
                    Налаштування сповіщень
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content open" id="configContent">
                    <div id="configTableContainer" style="text-align: left;">
                        <!-- Сюда будет загружена таблица -->
                    </div>
                    <!-- Контейнер для статуса (ПЕРЕМЕЩЕН ПОД ТАБЛИЦУ) -->
                    <div id="configStatus" class="status-message" style="text-align: center; margin-top: 20px;"></div>
                </div>
            </div>
            <!-- КОНЕЦ АККОРДЕОНА 1 -->
            
            <!-- НОВЫЙ АККОРДЕОН 2: Email користувачів -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion('emailContent')">
                    Email користувачів
                    <span class="accordion-icon">▼</span>
                </div>
                <!-- Убран класс 'open', чтобы блок был свернут по умолчанию -->
                <div class="accordion-content" id="emailContent">
                    <div id="emailListContainer">
                        <!-- Сюда будет загружен список email'ов -->
                        <!-- Сообщение о загрузке будет отображено при инициализации в JS -->
                    </div>
                </div>
            </div>
            <!-- КОНЕЦ АККОРДЕОНА 2 -->
            
           </div>
    </div>



    <script>
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxiFpwrkbINal0wGhPxMy0wd452HF3Q64yPqXyntLG9HC7gIus6zY2hQoqrcWH_EROf/exec';
        
        // Глобальная переменная для хранения загруженных данных
        let appData = null;
        
        // --- Вспомогательные функции ---
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // ФУНКЦИЯ: Плавное сворачивание/разворачивание
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling; 
            const icon = header.querySelector('.accordion-icon');
            
            if (contentId === 'configContent' && content.classList.contains('open')) {
                const statusDiv = document.getElementById('configStatus');
                statusDiv.style.display = 'none';
            }

            content.classList.toggle('open');
            header.classList.toggle('active');

            if (content.classList.contains('open')) {
                // Развернуть: устанавливаем max-height на фактическую высоту контента + БУФЕР
                content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
                icon.innerHTML = '▲';
            } else {
                // Свернуть
                content.style.maxHeight = '0';
                icon.innerHTML = '▼';
            }
        }

        function toggleMenu() {
            const menu = document.getElementById("sideMenu");
            menu.classList.toggle("open");
        }
        
        function closeWebView() {
            console.log("Attempting to close WebView...");
            if (typeof Android !== 'undefined' && Android.closeApp) {
                Android.closeApp();
            } else {
                console.warn("Native Android closeApp interface not found. Cannot close application.");
            }
        }
        
        
        /* --- ФУНКЦИИ: Переключение статуса Email и PUSH --- */
        
        // --- Общая функция для отправки запроса на обновление ---
        async function updateConfigStatus(sheetRow, currentFlag, targetColumn, event) {
            // targetColumn: 5 для Email (E) или 6 для PUSH (F)
            
            // Предотвращаем обработку клика несколько раз
            if (event.target.classList.contains('status-loading')) return;

            const statusDiv = document.getElementById('configStatus');
            const newStatus = currentFlag === '1' ? '0' : '1';
            
            // Включаем индикатор загрузки на элементе
            const indicator = event.target;
            const originalHTML = indicator.innerHTML;
            indicator.innerHTML = '🔄';
            indicator.classList.add('status-loading');
            
            statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> Оновлення статусу рядка ${sheetRow} у колонці ${targetColumn}...</span>`;
            statusDiv.style.display = 'block';

            // Принудительный перерасчет высоты, чтобы вместить индикатор
            const content = document.getElementById('configContent');
            if (content && content.classList.contains('open')) {
                content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
            }

            try {
                const formData = new FormData();
                formData.append('updateConfig', '1');
                formData.append('row', sheetRow); 
                formData.append('status', newStatus);
                formData.append('column', targetColumn); 

                const resp = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await resp.text();

                if (responseText.includes('Success')) {
                    // Выводим успех
                    statusDiv.innerHTML = '✅ Статус оновлено успішно.';
                    
                    // Перезагружаем данные
                    await loadConfig(); 
                } else {
                    throw new Error(responseText);
                }

            } catch (err) {
                statusDiv.innerHTML = `<p style="color: var(--status-error);">⚠️ Помилка оновлення: ${err.message || 'Невідома помилка'}</p>`;
                console.error('Помилка POST-запиту:', err);
                
                // Откатываем UI изменения при ошибке
                indicator.innerHTML = originalHTML;
                indicator.classList.remove('status-loading');
            }
            
            // Скрываем статус через короткое время
            setTimeout(() => { 
                statusDiv.style.display = 'none'; 
                // Обновляем высоту аккордеона после скрытия статуса
                if (content && content.classList.contains('open')) {
                    content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
                }
            }, 3000);
        }
        
        // Функция для колонки "Отримувати Email" (Колонка E, индекс 5)
        async function toggleEmailStatus(sheetRow, currentFlag, event) {
            await updateConfigStatus(sheetRow, currentFlag, 5, event);
        }

        // Функция для колонки "Отримувати PUSH" (Колонка F, индекс 6)
        async function togglePushStatus(sheetRow, currentFlag, event) {
            await updateConfigStatus(sheetRow, currentFlag, 6, event);
        }
        
        /* --- НОВАЯ ФУНКЦИЯ РЕНДЕРИНГА EMAIL-СПИСКА --- */
        
        // Рендеринг таблицы email-адресов: использует user_a и email
        function renderEmailListTable(data, container) {
            let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Користувач</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((row) => {
                // Используем данные из колонки B (user_a) и D (email)
                html += `
                    <tr>
                        <td>${row.user_a}</td>
                        <td><a href="mailto:${row.email}" class="email-link">${row.email}</a></td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }


        // --- ОСНОВНАЯ ФУНКЦИЯ: Загрузка конфигурации рассылки ---
        async function loadConfig() {
            const configDiv = document.getElementById('configTableContainer');
            const emailListDiv = document.getElementById('emailListContainer');
            const statusDiv = document.getElementById('configStatus');
            
            // Индикация загрузки для АККОРДЕОНА 1 (ВОССТАНОВЛЕНА С inline-spinner-wrapper)
            statusDiv.innerHTML = `<span class="inline-spinner-wrapper"><span class="inline-spinner"></span> Завантаження конфігурації...</span>`; 
            statusDiv.style.display = 'block';

            // Индикация загрузки для АККОРДЕОНА 2 (ВОССТАНОВЛЕНА С inline-spinner-wrapper)
            emailListDiv.innerHTML = `
                <p style="text-align: center; color: var(--text-color);">
                    <span class="inline-spinner-wrapper"><span class="inline-spinner"></span> Завантаження списку email'ів...</span>
                </p>`;
            
            // Аккордеон 1
            const contentConfig = document.getElementById('configContent');
            if (contentConfig && contentConfig.classList.contains('open')) {
                contentConfig.style.maxHeight = (contentConfig.scrollHeight + 50) + "px"; 
            }

            // Аккордеон 2
            const contentEmail = document.getElementById('emailContent');
            if (contentEmail && contentEmail.classList.contains('open')) {
                contentEmail.style.maxHeight = (contentEmail.scrollHeight + 50) + "px";
            }


            try {
                // Запрос к GAS для получения данных в формате JSON
                const resp = await fetch(WEBAPP_URL + '?getConfig=1'); 
                const dataText = await resp.text(); // Ожидаем TEXT для CORS
                const data = JSON.parse(dataText);
                
                appData = data; // Сохраняем данные глобально

                if (!appData || appData.length === 0) {
                    configDiv.innerHTML = '<p>Конфігурація розсилки не знайдена або пуста.</p>';
                    emailListDiv.innerHTML = '<p style="text-align: center;">Список email не знайдено.</p>';
                } else {
                    // РЕНДЕРИНГ АККОРДЕОНА 1
                    renderConfigTable(appData, configDiv);
                    
                    // РЕНДЕРИНГ АККОРДЕОНА 2
                    renderEmailListTable(appData, emailListDiv);

                    // Разворачиваем аккордеон 1 после рендеринга
                    setTimeout(() => {
                        if (contentConfig && contentConfig.classList.contains('open')) {
                            contentConfig.style.maxHeight = (contentConfig.scrollHeight + 50) + "px"; 
                            document.getElementById('configHeader').classList.add('active');
                            document.getElementById('configHeader').querySelector('.accordion-icon').innerHTML = '▲';
                        }
                    }, 50);
                }
                
                // Скрытие статуса после успешной загрузки
                statusDiv.style.display = 'none';

            } catch (err) {
                // В случае ошибки показываем статус внутри аккордеона 1
                statusDiv.innerHTML = '<p style="color: var(--status-error);">⚠️ Помилка при завантаженні конфігурації. Перевірте ГАS.</p>';
                configDiv.innerHTML = '';
                console.error('Помилка конфігурації:', err);
                
                // Сброс лоадера для аккордеона 2
                emailListDiv.innerHTML = '<p style="text-align: center; color: var(--status-error);">⚠️ Помилка завантаження списку email\'ів.</p>';

                // Растягиваем аккордеоны, чтобы вместить сообщение об ошибке
                if (contentConfig && contentConfig.classList.contains('open')) {
                    contentConfig.style.maxHeight = (contentConfig.scrollHeight + 50) + "px";
                }
                if (contentEmail && contentEmail.classList.contains('open')) {
                    contentEmail.style.maxHeight = (contentEmail.scrollHeight + 50) + "px";
                }
            }
        }

        // --- ИЗМЕНЕНИЕ: Рендеринг таблицы ---
        function renderConfigTable(data, container) {
            let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Користувач</th>
                            <!-- <th>Email</th> -->
                            <th class="status-col">Отримувати Email</th>
							<th class="status-col">Отримувати PUSH</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((row, index) => {
                const isEmailActive = row.flag === '1';
                const isPushActive = row.flagP === '1'; 
                // Номер строки в Google Sheet: index + 2 (т.к. читаем с A2)
                const sheetRow = index + 2; 

				// Элементы для Email (Колонка E)
                const emailIcon = isEmailActive ? '🟢' : '🔴';
                const emailClass = isEmailActive ? 'active' : 'inactive';
                
                // Элементы для Push (Колонка F)
                const pushIcon = isPushActive ? '🟢' : '🔴';
                const pushClass = isPushActive ? 'active' : 'inactive';

                html += `
                     <tr class="row-${isEmailActive ? 'active' : 'inactive'}">
                        <td>${row.user_a}</td>
                        <!-- <td class="email-col">${row.email}</td> -->
                        <td class="status-col">
                            <span class="status-indicator status-${emailClass}" 
                                  onclick="toggleEmailStatus(${sheetRow}, '${row.flag}', event)">
                                ${emailIcon} ${isEmailActive ? 'Так' : 'Ні'}
                            </span>
                        </td>
						<td class="status-col">
                            <span class="status-indicator status-${pushClass}" 
                                  onclick="togglePushStatus(${sheetRow}, '${row.flagP}', event)">
                                 ${pushIcon} ${isPushActive ? 'Так' : 'Ні'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- Инициализация ---
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }            
			
            loadConfig(); 
        });

    </script>
</body>
</html>
