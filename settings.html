<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Налаштування розсилки</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        
        <!-- Кнопка меню -->
        <button class="menu-button" onclick="toggleMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>

        <div class="form-wrapper">

            <!-- Боковое меню (Убрано, чтобы избежать дублирования кода) -->
            <div class="side-menu" id="sideMenu">
                <button class="close-button" onclick="toggleMenu()">❌</button>
                <ul>
                    <li><a href="index.html">🏠 Головна</a></li> 
                    <li><a href="history.html">📜 Історія</a></li> 
                    <li><a href="stats.html">📈 Статистика</a></li>
                    <li><a href="settings.html">⚙️ Налаштування</a></li>
                    <li><a href="#" onclick="closeWebView()">🚪 Вихід</a></li>
                </ul>
                <button type="button" class="theme-toggle" onclick="toggleTheme()">🌓 Змінити тему</button>
            </div>


            <!-- Основное содержимое -->
            <h2>Системні налаштування</h2>

            <!-- АККОРДЕОН 1: Налаштування сповіщень користувачів -->
            <div class="accordion-item">
                <div class="accordion-header" id="configHeader" onclick="toggleAccordion('configContent')">
                    Налаштування сповіщень користувачів 🔔
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content open" id="configContent">
                    <div id="configTableContainer" style="text-align: left;">
                        <!-- Сюда будет загружена таблица -->
                    </div>
                    <!-- Контейнер для статуса (ПЕРЕМЕЩЕН ПОД ТАБЛИЦУ) -->
                    <div id="configStatus" class="status-message" style="text-align: center; margin-top: 20px;"></div>
                </div>
            </div>
            <!-- КОНЕЦ АККОРДЕОНА 1 -->
            
            <!-- НОВЫЙ АККОРДЕОН 2: Email користувачів -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion('emailContent')">
                    Email користувачів 📧
                    <span class="accordion-icon">▼</span>
                </div>
                <!-- Убран класс 'open', чтобы блок был свернут по умолчанию -->
                <div class="accordion-content" id="emailContent">
                    <div id="emailListContainer">
                        <p style="text-align: center; color: var(--text-color);">Список email'ів буде завантажено тут.</p>
                        <!-- Сюда будет загружен список email'ов -->
                    </div>
                </div>
            </div>
            <!-- КОНЕЦ АККОРДЕОНА 2 -->
            
            <!-- Версия сборки -->
            <p id="buildVersion" style="margin-top: 20px; font-size: 0.75rem; color: #999; text-align: center;"></p>
            
        </div>
    </div>

    <script>
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxiFpwrkbINal0wGhPxMy0wd452HF3Q64yPqXyntLG9HC7gIus6zY2hQoqrcWH_EROf/exec';
        
        // --- Вспомогательные функции ---
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // НОВАЯ ФУНКЦИЯ: Плавное сворачивание/разворачивание
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling; // header находится перед content
            const icon = header.querySelector('.accordion-icon');
            
            // Если аккордеон закрывается, сначала скрываем статус (актуально только для configContent)
            if (contentId === 'configContent' && content.classList.contains('open')) {
                const statusDiv = document.getElementById('configStatus');
                statusDiv.style.display = 'none';
            }

            content.classList.toggle('open');
            header.classList.toggle('active');

            if (content.classList.contains('open')) {
                // Развернуть: устанавливаем max-height на фактическую высоту контента + БУФЕР
                // Увеличенный буфер 50px для запаса
                content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
                icon.innerHTML = '▲';
            } else {
                // Свернуть
                content.style.maxHeight = '0';
                icon.innerHTML = '▼';
            }
        }

        function toggleMenu() {
            const menu = document.getElementById("sideMenu");
            menu.classList.toggle("open");
        }
        
        function closeWebView() {
            console.log("Attempting to close WebView...");
            if (typeof Android !== 'undefined' && Android.closeApp) {
                Android.closeApp();
            } else {
                console.warn("Native Android closeApp interface not found. Cannot close application.");
            }
        }
        
        // --- УДАЛЕНА hideLoading() ---
        
        /* --- ФУНКЦИИ: Переключение статуса Email и PUSH --- */
        
        // --- Общая функция для отправки запроса на обновление ---
        async function updateConfigStatus(sheetRow, currentFlag, targetColumn, event) {
            // targetColumn: 5 для Email (E) или 6 для PUSH (F)
            
            // Предотвращаем обработку клика несколько раз
            if (event.target.classList.contains('status-loading')) return;

            const statusDiv = document.getElementById('configStatus');
            const newStatus = currentFlag === '1' ? '0' : '1';
            
            // Включаем индикатор загрузки на элементе
            const indicator = event.target;
            const originalHTML = indicator.innerHTML;
            indicator.innerHTML = '🔄';
            indicator.classList.add('status-loading');
            
            // ИСПРАВЛЕНО: Теперь выводим спиннер + текст
            statusDiv.innerHTML = `<div class="inline-spinner-wrapper"><div class="inline-spinner"></div> Оновлення статусу рядка ${sheetRow} у колонці ${targetColumn}...</div>`;
            // Важно: отображаем статус, когда начинаем операцию
            statusDiv.style.display = 'block';

            // НОВОЕ: Пересчитываем высоту, чтобы учесть новый блок статуса
            const content = document.getElementById('configContent');
            if (content && content.classList.contains('open')) {
                // Принудительный перерасчет + буфер 50px
                content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
            }

            try {
                const formData = new FormData();
                formData.append('updateConfig', '1');
                formData.append('row', sheetRow); 
                formData.append('status', newStatus);
                // НОВОЕ: Передаем в GAS номер колонки для обновления
                formData.append('column', targetColumn); 

                const resp = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await resp.text();

                if (responseText.includes('Success')) {
                    // ИСПРАВЛЕНО: Теперь выводим эмодзи + текст
                    statusDiv.innerHTML = '✅ Статус оновлено успішно.';
                    // Обновляем только loadConfig, так как только она отвечает за данные таблицы Config
                    await loadConfig(); 
                } else {
                    throw new Error(responseText);
                }

            } catch (err) {
                statusDiv.innerHTML = `<p style="color: var(--status-error);">⚠️ Помилка оновлення: ${err.message || 'Невідома помилка'}</p>`;
                console.error('Помилка POST-запиту:', err);
                
                // Откатываем UI изменения при ошибке
                indicator.innerHTML = originalHTML;
                indicator.classList.remove('status-loading');
            }
            
            // Скрываем статус через короткое время
            setTimeout(() => { 
                statusDiv.style.display = 'none'; 
                // Обновляем высоту аккордеона после скрытия статуса
                if (content && content.classList.contains('open')) {
                    // Использование БУФЕРА
                    content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
                }
            }, 3000);
        }
        
        // Функция для колонки "Отримувати Email" (Колонка E, индекс 5)
        async function toggleEmailStatus(sheetRow, currentFlag, event) {
            await updateConfigStatus(sheetRow, currentFlag, 5, event);
        }

        // Функция для колонки "Отримувати PUSH" (Колонка F, индекс 6)
        async function togglePushStatus(sheetRow, currentFlag, event) {
            await updateConfigStatus(sheetRow, currentFlag, 6, event);
        }
        /* --- КОНЕЦ НОВЫХ ФУНКЦИЙ --- */

        // --- НОВАЯ ФУНКЦИЯ: Загрузка списка email'ов (ВОССТАНОВЛЕНА ИНДИКАЦИЯ) ---
        async function loadEmailList() {
            const container = document.getElementById('emailListContainer');
            
            // ВОССТАНОВЛЕНО: Индикация загрузки со спиннером
            container.innerHTML = `
                <p style="text-align: center; color: var(--text-color);">
                    <div class="inline-spinner-wrapper"><div class="inline-spinner"></div> Завантаження списку email'ів...</div>
                </p>`;
            
            // Имитация загрузки данных (замените на реальный fetch к GAS)
            await new Promise(resolve => setTimeout(resolve, 800)); 
            
            // ЗАГЛУШКА ДАННЫХ
            const mockEmails = [
                { user: "Петро К.", email: "petro.k@example.com", department: "Продажі" },
                { user: "Олена С.", email: "olena.s@example.com", department: "Розробка" },
                { user: "Іван М.", email: "ivan.m@example.com", department: "Адмін" },
                { user: "Марія В.", email: "maria.v@example.com", department: "Маркетинг" }
            ];

            let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Ім'я</th>
                            <th>Email</th>
                            <th>Відділ</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            mockEmails.forEach(item => {
                html += `
                    <tr>
                        <td>${item.user}</td>
                        <td><a href="mailto:${item.email}">${item.email}</a></td>
                        <td>${item.department}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }


        // --- ОСНОВНАЯ ФУНКЦИЯ: Загрузка конфигурации рассылки (ВОССТАНОВЛЕНА ИНДИКАЦИЯ) ---
        async function loadConfig() {
            const configDiv = document.getElementById('configTableContainer');
            const statusDiv = document.getElementById('configStatus');
            
            // ВОССТАНОВЛЕНО: Индикация загрузки со спиннером
            statusDiv.innerHTML = `<div class="inline-spinner-wrapper"><div class="inline-spinner"></div> Завантаження конфігурації...</div>`;
            statusDiv.style.display = 'block';

            // Принудительный перерасчет высоты, чтобы вместить спиннер
            const content = document.getElementById('configContent');
            if (content && content.classList.contains('open')) {
                // Использование БУФЕРА
                content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
            }


            try {
                // Запрос к GAS для получения данных в формате JSON
                const resp = await fetch(WEBAPP_URL + '?getConfig=1'); 
                const dataText = await resp.text(); // Ожидаем TEXT для CORS
                const data = JSON.parse(dataText);
                
                if (!data || data.length === 0) {
                    configDiv.innerHTML = '<p>Конфігурація розсилки не знайдена або пуста.</p>';
                } else {
                    renderConfigTable(data, configDiv);
                    // Разворачиваем аккордеон после рендеринга таблицы
                    setTimeout(() => {
                        // ВАЖНО: После рендеринга таблицы высота увеличится, поэтому 
                        // пересчитываем maxHeight, чтобы таблица поместилась
                        if (content && content.classList.contains('open')) {
                            // Использование БУФЕРА
                            content.style.maxHeight = (content.scrollHeight + 50) + "px"; 
                            document.getElementById('configHeader').classList.add('active');
                            document.getElementById('configHeader').querySelector('.accordion-icon').innerHTML = '▲';
                        }
                    }, 50);
                }
                
                // ВОССТАНОВЛЕНО: Скрытие статуса после успешной загрузки
                statusDiv.style.display = 'none';

            } catch (err) {
                // В случае ошибки показываем статус внутри аккордеона
                statusDiv.innerHTML = '<p style="color: var(--status-error);">⚠️ Помилка при завантаженні конфігурації. Перевірте ГАS.</p>';
                configDiv.innerHTML = '';
                console.error('Помилка конфігурації:', err);
                
                // Растягиваем аккордеон, чтобы вместить сообщение об ошибке
                const content = document.getElementById('configContent');
                if (content && content.classList.contains('open')) {
                    // Использование БУФЕРА
                    content.style.maxHeight = (content.scrollHeight + 50) + "px";
                }
            }
        }

        // --- ИЗМЕНЕНИЕ: Рендеринг таблицы (Убран заголовок H3) ---
        function renderConfigTable(data, container) {
            let html = `
                <div class="table-scroll">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Користувач</th>
                            <!-- <th>Email</th> -->
                            <th class="status-col">Отримувати Email</th>
							<th class="status-col">Отримувати PUSH</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((row, index) => {
                const isEmailActive = row.flag === '1';
                const isPushActive = row.flagP === '1'; 
                // Номер строки в Google Sheet: index + 2 (т.к. читаем с A2)
                const sheetRow = index + 2; 

				// Элементы для Email (Колонка E)
                const emailIcon = isEmailActive ? '🟢' : '🔴';
                const emailClass = isEmailActive ? 'active' : 'inactive';
                
                // Элементы для Push (Колонка F)
                const pushIcon = isPushActive ? '🟢' : '🔴';
                const pushClass = isPushActive ? 'active' : 'inactive';

                html += `
                     <tr class="row-${isEmailActive ? 'active' : 'inactive'}">
                        <td>${row.user_a}</td>
                        <!-- <td class="email-col">${row.email}</td> -->
                        <td class="status-col">
                            <span class="status-indicator status-${emailClass}" 
                                  onclick="toggleEmailStatus(${sheetRow}, '${row.flag}', event)">
                                ${emailIcon} ${isEmailActive ? 'Так' : 'Ні'}
                            </span>
                        </td>
						<td class="status-col">
                            <span class="status-indicator status-${pushClass}" 
                                  onclick="togglePushStatus(${sheetRow}, '${row.flagP}', event)">
                                 ${pushIcon} ${isPushActive ? 'Так' : 'Ні'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- Инициализация ---
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }            
            document.getElementById('buildVersion').textContent = getBuildVersion(); 
            // ВОССТАНОВЛЕНО: вызовы функций напрямую
            loadConfig(); 
            loadEmailList();
        });
        
        // --- Добавлена отсутствующая функция getBuildVersion ---
        function getBuildVersion() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `v${year}.${month}.${day}.${hours}${minutes}`; 
        }

    </script>
</body>
</html>
