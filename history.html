<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Історія показників</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />

    <!-- Подключаем файл конфигурации ПЕРЕД основным скриптом -->
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="./firebase-init.js"></script>
    <script src="utils.js"></script>

    <script>
      // Функция генерации списка месяцев
      function getMonthList() {
        const monthNames = [
          "Січень", "Лютий", "Березень", "Квітень", "Травень", "Червень",
          "Липень", "Серпень", "Вересень", "Жовтень", "Листопад", "Грудень"
        ];
        
        // НАСТРОЙКА: С какой даты начинать историю (Год, Месяц - 1)
        // 1 = Февраль (так как отсчет с 0: Январь=0, Февраль=1)
        const startDate = new Date(2025, 1, 1); 
        
        const currentDate = new Date();
        // Сбрасываем день на 1-е число, чтобы избежать ошибок при перелистывании месяцев (например с 31-го числа)
        currentDate.setDate(1); 
        
        const result = [];

        // Цикл от текущей даты назад до startDate
        while (currentDate >= startDate) {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          
          // Формируем value вида "2026-02"
          const val = `${year}-${(month + 1).toString().padStart(2, '0')}`;
          // Формируем text вида "Лютий 2026"
          const txt = `${monthNames[month]} ${year}`;
          
          result.push({ value: val, text: txt });

          // Шаг назад на 1 месяц
          currentDate.setMonth(currentDate.getMonth() - 1);
        }
        return result;
      }

      // Автоматически заполняем константу
      const MONTHS = getMonthList();

      function populateMonthSelector() {
        const selector = document.getElementById("monthSelector");

        // Добавляем месяцы
        MONTHS.forEach((month) => {
          const option = document.createElement("option");
          option.value = month.value;
          option.textContent = month.text;
          selector.appendChild(option);
        });

        // Устанавливаем последний месяц (Сентябрь) как выбранный по умолчанию
        selector.value = MONTHS[0].value;
      }

      async function loadHistory() {
        const historyDiv = document.getElementById("history");
        const statusDiv = document.getElementById("loadingStatus");
        const monthSelector = document.getElementById("monthSelector");

        const selectedMonth = monthSelector.value;
        const monthName =
          monthSelector.options[monthSelector.selectedIndex].text;

        // ВИПРАВЛЕНО: Замість пісочного годинника використовуємо HTML-спіннер
        statusDiv.innerHTML = `<span class="inline-spinner-wrapper">
                                 <span class="inline-spinner"></span> 
                                 Завантаження історії за ${monthName}...
                               </span>`;
        statusDiv.style.display = "block";
        historyDiv.innerHTML = "";

        let url = WEBAPP_URL + "?history=1";

        // Если выбран конкретный месяц, добавляем его в URL
        if (selectedMonth) {
          url += `&month=${selectedMonth}`;
        } else {
          // ИЗМЕНЕНИЕ ЗДЕСЬ: Обновляем статус, если выбрана вся история
          statusDiv.innerHTML = `⏳ Завантаження усієї історії...`;
        }

        try {
          const resp = await fetch(url);
          const html = await resp.text();

          // ... (остальной код проверки на пустоту) ...

          if (html.trim() === "" || html.length < 50) {
            // Это сообщение отобразится, если выбрана "Уся історія", а данных нет.
            historyDiv.innerHTML = `<p style="text-align: center; color: var(--text-color); margin-top: 30px;">Записів за ${monthName} не знайдено.</p>`;
          } else {
            historyDiv.innerHTML = html;
          }

          statusDiv.style.display = "none";
        } catch (err) {
          statusDiv.innerHTML = "<p>⚠️ Помилка при завантаженні історії.</p>";
          console.error("Помилка історії:", err);
        }
      }

      window.addEventListener("DOMContentLoaded", async () => {
        // Загрузка сохраненной темы
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark");
        }
        await loadComponent("sidebar-placeholder", "sidebar.html");
        populateMonthSelector();
        loadHistory(); // Загрузка истории для выбранного по умолчанию месяца
      });
    </script>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-N0T0138X0Q");
    </script>
  </head>
  <body>
    <div class="container">
      <button class="menu-button" onclick="toggleMenu()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4 6H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 12H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 18H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div class="form-wrapper">
        <!-- Боковое меню зачитываем из utils.js-->
        <div id="sidebar-placeholder"></div>

        <h2>Історія передачі показників</h2>

        <div style="margin-bottom: 20px; text-align: left">
          <label
            for="monthSelector"
            style="font-weight: bold; margin-bottom: 5px"
            >Вибрати період:</label
          >
          <select id="monthSelector" onchange="loadHistory()"></select>
        </div>

        <div
          id="loadingStatus"
          style="display: none; text-align: center; padding: 20px"
        ></div>

        <div id="history"></div>
      </div>
    </div>

    <script>
      // Проверка статуса авторизации при загрузке страницы
      auth.onAuthStateChanged((user) => {
        if (!user) {
          // Если пользователь НЕ авторизован
          console.log(
            "Пользователь не авторизован. Перенаправление на страницу входа."
          );
          // Перенаправить на страницу входа
          window.location.replace("auth.html");
        } else {
          // Пользователь авторизован
          console.log("Пользователь авторизован как:", user.email);
          // Здесь можно выполнять код для авторизованных пользователей (например, загрузку данных из Firestore)
        }
      });

      // // (Ваш существующий код для загрузки данных из GAS должен быть ниже этого блока)
    </script>
  </body>
</html>
