<!DOCTYPE html>
<html>
<head>
    <title>EV Зарядки поблизости</title>
    <style>
        /* Стили для карты, чтобы она занимала весь экран */
        #map {
            height: 100vh;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsr-JbArcAu-7_csBxM6VDsC7hyPz7qB0&libraries=places"></script>

    <script>
        // Мы определяем асинхронную функцию, чтобы использовать 'await'
        async function initMap() {

            // --- НОВЫЙ БЛОК: ОПРЕДЕЛЕНИЕ ГЕОЛОКАЦИИ ---
            
            let centerLocation; // Объявляем переменную для центра
            const kyivCenter = { lat: 50.4501, lng: 30.5234 }; // Киев по умолчанию

            // Проверяем, доступна ли геолокация в браузере
            if (navigator.geolocation) {
                try {
                    // Создаем Promise, чтобы "дождаться" ответа пользователя
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            timeout: 5000 // Ждем ответа 5 секунд
                        });
                    });
                    
                    // УСПЕХ: Пользователь разрешил
                    centerLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                } catch (error) {
                    // ОШИБКА: Пользователь отклонил или произошел сбой
                    if (error.code === error.PERMISSION_DENIED) {
                        alert("Вы отклонили запрос геолокации. Показываем центр Киева.");
                    } else {
                        alert("Не удалось определить геолокацию. Показываем центр Киева.");
                    }
                    console.warn("Ошибка геолокации:", error.message);
                    centerLocation = kyivCenter; // Используем Киев
                }
            } else {
                // Браузер не поддерживает геолокацию
                alert("Ваш браузер не поддерживает геолокацию. Показываем центр Киева.");
                centerLocation = kyivCenter; // Используем Киев
            }
            // --- КОНЕЦ НОВОГО БЛОКА ---


            // 1. Ждем загрузки библиотек API
            const { Map } = await google.maps.importLibrary("maps");
            const { Place } = await google.maps.importLibrary("places");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const infowindow = new google.maps.InfoWindow();

            // 2. Создаем карту
            // ИСПОЛЬЗУЕМ 'centerLocation' вместо 'kyivCenter'
            const map = new Map(document.getElementById("map"), {
                center: centerLocation, // <-- ИЗМЕНЕНИЕ
                zoom: 14, // Увеличим зум, чтобы было видно детали
                mapId: "4a62d317fcaba9b4f0b995aa" // <-- ВАШ ID КАРТЫ
            });

            // 3. Формируем запрос для НОВОГО API
            const request = {
                includedTypes: ['electric_vehicle_charging_station'],
                locationRestriction: {
                    center: centerLocation, // <-- ИЗМЕНЕНИЕ
                    radius: 5000, // 5 км
                },
                // 'fields' (массив) - это правильный синтаксис
                fields: ['displayName', 'location', 'id']
            };

            // 4. Выполняем поиск
            try {
                const { places } = await Place.searchNearby(request);

                if (places && places.length > 0) {
                    
                    // 5. Создаем маркеры для каждой станции
                    places.forEach(place => {
                        // Используем новый "Продвинутый" маркер
                        const marker = new AdvancedMarkerElement({
                            map,
                            position: place.location,
                            title: place.displayName,
                        });

                        // 6. Добавляем слушатель клика
                        marker.addListener("click", async () => {
                            // Создаем объект Place для запроса деталей
                            const detailPlace = new Place({ id: place.id });

                            // Запрашиваем нужные поля (включая 'evChargeOptions' для цены)
                            await detailPlace.fetchFields({ 
                                fields: ['displayName', 'formattedAddress', 'evChargeOptions'] 
                            });

                            const details = detailPlace;

                            // 7. Ищем цену (логика та же)
                            let priceInfo = "Цена не указана";
                            if (details.evChargeOptions && details.evChargeOptions.connectorAggregations) {
                                const firstConnectorWithPrice = details.evChargeOptions.connectorAggregations.find(conn => conn.price);
                                if (firstConnectorWithPrice && firstConnectorWithPrice.price) {
                                    priceInfo = firstConnectorWithPrice.price.text; // "15,00 грн/кВт·год"
                                }
                            }

                            // 8. Показываем InfoWindow
                            const content = `
                                <div>
                                    <strong>${details.displayName}</strong><br>
                                    Адрес: ${details.formattedAddress || 'Адрес не указан'}<br>
                                    <strong>Цена: ${priceInfo}</strong>
                                D/div>
                            `;
                            
                            infowindow.setContent(content);
                            infowindow.open(map, marker);
                        });
                    });

                } else {
                    alert("В радиусе 5 км зарядных станций не найдено.");
                }

            } catch (error) {
                console.error("Ошибка поиска Places:", error);
                alert("Произошла ошибка при поиске станций.");
            }
        }

        // Вызываем функцию вручную
        initMap();
        
    </script>
</body>
</html>