<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Моніторинг Енергії</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="emonitor.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-N0T0138X0Q");
    </script>
  </head>
  <body>
    <div class="container">
      <button class="menu-button" onclick="toggleMenu()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M4 6H20M4 12H20M4 18H20"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div id="user-info-header">
        <div id="user-info-wrapper" onclick="showUserProfile()">
          <span id="user-email-display" title="Ваш користувач"></span>
        </div>
        <button
          id="logout-inline-button"
          onclick="handleLogout()"
          title="Вийти"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>

      <div class="form-wrapper monitor-view">
        <div id="sidebar-placeholder"></div>

        <h2>Моніторинг Енергомережі</h2>
        <p
          id="admin-status"
          style="text-align: center; margin-bottom: 10px; height: 20px"
        ></p>

        <div id="monitoring-section" style="display: none">
          <div class="dashboard-wrapper">
            <div
              class="info-card"
              id="card-voltage"
              onclick="setChartMode('voltage')"
              style="color: #ff9800"
            >
              <h3>Напруга</h3>
              <div class="value" style="color: inherit">
                <span id="disp-voltage">--</span><span class="unit">V</span>
              </div>
            </div>

            <div
              class="info-card active-card"
              id="card-power"
              onclick="setChartMode('power')"
              style="color: #007bff"
            >
              <h3>Потужність</h3>
              <div class="value" style="color: inherit">
                <span id="disp-power">--</span><span class="unit">W</span>
              </div>
            </div>

            <div
              class="info-card"
              id="card-energy"
              onclick="setChartMode('energy')"
              style="color: #6f42c1"
            >
              <h3>Лічильник (Total)</h3>
              <div class="value" style="color: inherit">
                <span id="disp-energy">--</span><span class="unit">kWh</span>
              </div>
            </div>

            <div
              class="info-card"
              id="card-daily"
              onclick="setChartMode('daily')"
              style="color: #28a745"
            >
              <h3>Сьогодні</h3>
              <div class="value" style="color: inherit">
                <span id="disp-daily">--</span><span class="unit">kWh</span>
              </div>
            </div>
          </div>

          <div id="range-selector-standard" class="range-selector">
            <button
              class="range-btn active"
              onclick="changeRange('standard', 250, this)"
            >
              1 год
            </button>
            <button
              class="range-btn"
              onclick="changeRange('standard', 750, this)"
            >
              3 год
            </button>
            <button
              class="range-btn"
              onclick="changeRange('standard', 1500, this)"
            >
              6 год
            </button>
            <button
              class="range-btn"
              onclick="changeRange('standard', 3000, this)"
            >
              12 год
            </button>
          </div>

          <div
            id="range-selector-history"
            class="range-selector"
            style="display: none"
          >
            <button
              class="range-btn active"
              onclick="changeRange('day', 5000, this)"
            >
              День
            </button>
            <button class="range-btn" onclick="changeRange('week', 9900, this)">
              Тиждень
            </button>
            <button
              class="range-btn"
              onclick="changeRange('month', 9900, this)"
            >
              Місяць
            </button>
          </div>

          <div class="chart-container">
            <canvas id="powerChart"></canvas>
            <button class="reset-zoom-btn" onclick="powerChart.resetZoom()">
              ⟲ Zoom
            </button>
          </div>

          <h3 class="logs-title">Журнал подій (System Logs)</h3>
          <div class="logs-container">
            <table id="logs-table">
              <thead>
                <tr>
                  <th>Час</th>
                  <th>Подія</th>
                  <th>Причина</th>
                </tr>
              </thead>
              <tbody id="logs-body">
                <tr>
                  <td
                    colspan="3"
                    style="text-align: center; padding: 15px; opacity: 0.7"
                  >
                    Завантаження...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p
          id="buildVersion"
          style="
            margin-top: 20px;
            font-size: 0.75rem;
            color: #999;
            text-align: center;
          "
        ></p>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="./firebase-init.js"></script>
    <script src="utils.js"></script>

    <script>
      let isAdmin = false;
      let powerChart = null;
      let currentMode = "power";
      let currentRangeType = "standard"; // 'standard', 'day', 'week', 'month'
      let todayStartEnergy = null;
      let unsubscribeMeter = null;
      let currentLimit = 250;

      let cachedData = {
        labels: [],
        fullDates: [],
        power: [],
        voltage: [],
        energy: [],
        dailyEnergyProfile: [],
      };

      const chartColors = {
        power: { color: "rgb(0, 123, 255)", bg: "rgba(0, 123, 255, 0.1)" },
        voltage: { color: "rgb(255, 152, 0)", bg: "rgba(255, 152, 0, 0.1)" },
        energy: { color: "rgb(111, 66, 193)", bg: "rgba(111, 66, 193, 0.6)" },
        daily: { color: "rgb(40, 167, 69)", bg: "rgba(40, 167, 69, 0.1)" },
      };

      // --- СМЕНА РЕЖИМА ГРАФИКА (Кнопки) ---
      window.setChartMode = function (mode) {
        if (currentMode === mode) return;
        currentMode = mode;

        document
          .querySelectorAll(".info-card")
          .forEach((el) => el.classList.remove("active-card"));
        document.getElementById(`card-${mode}`).classList.add("active-card");

        const standardBtns = document.getElementById("range-selector-standard");
        const historyBtns = document.getElementById("range-selector-history");

        if (mode === "energy") {
          // Режим счетчика -> кнопки истории
          standardBtns.style.display = "none";
          historyBtns.style.display = "flex";

          // Сразу активируем "День"
          changeRange("day", 10000, historyBtns.querySelector(".range-btn"));

          initPowerMonitor("bar");
        } else {
          // Остальные режимы -> стандартные кнопки
          historyBtns.style.display = "none";
          standardBtns.style.display = "flex";

          // Сразу активируем "1 год"
          changeRange(
            "standard",
            250,
            standardBtns.querySelector(".range-btn")
          );

          initPowerMonitor("line");
        }
      };

      // --- СМЕНА ДИАПАЗОНА (Логика лимитов) ---
      window.changeRange = function (type, limit, btn) {
        document
          .querySelectorAll(".range-btn")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");

        currentLimit = limit;
        currentRangeType = type;

        if (unsubscribeMeter) {
          unsubscribeMeter();
          unsubscribeMeter = null;
        }
        startMeterListener();
        if (powerChart) powerChart.resetZoom();
      };

      // === ПОЛУЧЕНИЕ НОМЕРА НЕДЕЛИ ===
      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return weekNo;
      }

      // === НАЗВАНИЯ МЕСЯЦЕВ ===
      function getMonthNameUA(monthIndex) {
        const months = [
          "Січень",
          "Лютий",
          "Березень",
          "Квітень",
          "Травень",
          "Червень",
          "Липень",
          "Серпень",
          "Вересень",
          "Жовтень",
          "Листопад",
          "Грудень",
        ];
        return months[monthIndex];
      }

      // === ГЛАВНАЯ ЛОГИКА ОБРАБОТКИ СТОЛБИКОВ ===
      function processBarData() {
        if (cachedData.energy.length < 2) return { labels: [], data: [] };

        const grouped = {};

        // 1. Проходим по всем данным
        cachedData.fullDates.forEach((dateStr, index) => {
          const dateObj = new Date(dateStr);
          if (isNaN(dateObj)) return;

          let key = "";
          let label = "";
          let sortKey = 0;

          // --- ЛОГИКА ДЛЯ ДНЯ (7 дней) ---
          if (currentRangeType === "day") {
            // Ключ: YYYY-MM-DD (уникальный день)
            key = dateObj.toISOString().split("T")[0];
            // Подпись: 17.12
            label = `${String(dateObj.getDate()).padStart(2, "0")}.${String(
              dateObj.getMonth() + 1
            ).padStart(2, "0")}`;
            sortKey = dateObj.getTime();
          }
          // --- ЛОГИКА ДЛЯ НЕДЕЛИ (4 недели) ---
          else if (currentRangeType === "week") {
            const weekNum = getWeekNumber(dateObj);
            const year = dateObj.getFullYear();
            // Ключ: 2025-W51
            key = `${year}-W${weekNum}`;
            // Подпись: Тиждень 51
            label = `Тиждень ${weekNum}`;
            // Сортировка по номеру года + недели
            sortKey = year * 100 + weekNum;
          }
          // --- ЛОГИКА ДЛЯ МЕСЯЦА (12 месяцев) ---
          else if (currentRangeType === "month") {
            const month = dateObj.getMonth();
            const year = dateObj.getFullYear();
            // Ключ: 2025-11 (Год-Месяц)
            key = `${year}-${month}`;
            // Подпись: Грудень
            label = getMonthNameUA(month);
            sortKey = year * 100 + month;
          } else {
            return { labels: [], data: [] };
          }

          // Инициализируем группу, если её нет
          if (!grouped[key]) {
            grouped[key] = {
              min: Infinity,
              max: -Infinity,
              label: label,
              sort: sortKey,
            };
          }

          // Ищем мин и макс счетчика в этот период
          const val = cachedData.energy[index];
          if (val < grouped[key].min) grouped[key].min = val;
          if (val > grouped[key].max) grouped[key].max = val;
        });

        // 2. Превращаем в массив и сортируем по времени
        let sortedKeys = Object.keys(grouped).sort(
          (a, b) => grouped[a].sort - grouped[b].sort
        );

        // 3. Обрезаем массив (берем только последние N элементов)
        if (currentRangeType === "day") {
          sortedKeys = sortedKeys.slice(-7); // Последние 7 дней
        }
        if (currentRangeType === "week") {
          sortedKeys = sortedKeys.slice(-4); // Последние 4 недели
        }
        if (currentRangeType === "month") {
          sortedKeys = sortedKeys.slice(-12); // Последние 12 месяцев
        }

        const resultLabels = [];
        const resultData = [];

        sortedKeys.forEach((key) => {
          const item = grouped[key];
          let consumption = item.max - item.min;

          // Фильтры от "мусора"
          if (consumption < 0) consumption = 0;
          // Если дельта слишком огромная (сбой счетчика), игнорируем
          if (consumption > 2000) consumption = 0;

          resultLabels.push(item.label);
          resultData.push(consumption.toFixed(2));
        });

        return { labels: resultLabels, data: resultData };
      }

      function updateChartData() {
        if (!powerChart) return;

        const colors = chartColors[currentMode];
        let labelText = "";
        const todayStr = new Date().toLocaleDateString("uk-UA");

        if (currentMode === "energy") {
          // === СТРОИМ СТОЛБИКИ ===
          const barData = processBarData();

          if (currentRangeType === "day")
            labelText = "Споживання за останні 7 днів (kWh)";
          else if (currentRangeType === "week")
            labelText = "Споживання за останні 4 тижні (kWh)";
          else if (currentRangeType === "month")
            labelText = "Споживання за останні 12 місяців (kWh)";
          else labelText = "Споживання (kWh)";

          powerChart.data.labels = barData.labels;
          powerChart.data.datasets[0].data = barData.data;
          powerChart.options.scales.y.beginAtZero = true;
        } else {
          // === СТРОИМ ЛИНИИ (обычные) ===
          switch (currentMode) {
            case "power":
              labelText = "Потужність (W)";
              break;
            case "voltage":
              labelText = "Напруга (V)";
              break;
            case "daily":
              labelText = `Споживання за ${todayStr} (kWh)`;
              break;
          }

          if (currentMode === "daily") {
            powerChart.data.datasets[0].data = cachedData.dailyEnergyProfile;
          } else {
            powerChart.data.datasets[0].data = cachedData[currentMode];
          }

          powerChart.data.labels = cachedData.labels;

          if (currentMode === "voltage") {
            powerChart.options.scales.y.beginAtZero = false;
          } else {
            powerChart.options.scales.y.beginAtZero = true;
          }
        }

        powerChart.data.datasets[0].label = labelText;
        powerChart.data.datasets[0].borderColor = colors.color;
        powerChart.data.datasets[0].backgroundColor = colors.bg;
        powerChart.update();
      }

      function fetchTodayStartEnergy() {
        const now = new Date();
        const dateString =
          now.getFullYear() +
          "-" +
          String(now.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(now.getDate()).padStart(2, "0");
        const startOfDayStr = dateString + " 00:00:00";

        db.collection("meter_readings")
          .where("created_at", ">=", startOfDayStr)
          .orderBy("created_at", "asc")
          .limit(1)
          .get()
          .then((snapshot) => {
            if (!snapshot.empty)
              todayStartEnergy = snapshot.docs[0].data().energy;
            else todayStartEnergy = null;
          })
          .catch((error) => console.error("Index Error:", error));
      }

      function startMeterListener() {
        console.log("Запит до бази з лімітом:", currentLimit);

        if (unsubscribeMeter) unsubscribeMeter();

        unsubscribeMeter = db
          .collection("meter_readings")
          .orderBy("created_at", "desc")
          .limit(currentLimit)
          .onSnapshot(
            (snapshot) => {
              // === ДИАГНОСТИКА ===
              console.log(`--- ОТРИМАНО ДАНИХ ---`);
              console.log(`Кількість записів: ${snapshot.size}`);
              if (!snapshot.empty) {
                const newest = snapshot.docs[0].data().created_at;
                const oldest =
                  snapshot.docs[snapshot.size - 1].data().created_at;
                console.log(`Найновіший запис: ${newest}`);
                console.log(`Найстаріший запис: ${oldest}`);

                // Расчет плотности
                const d1 = new Date(newest);
                const d2 = new Date(oldest);
                const diffHours = Math.abs(d1 - d2) / 36e5;
                console.log(`Охоплено годин: ${diffHours.toFixed(1)}`);
              } else {
                console.log("Даних немає взагалі!");
              }
              // ===================

              const temps = {
                labels: [],
                fullDates: [],
                power: [],
                voltage: [],
                energy: [],
                dailyEnergyProfile: [],
              };
              let latestDoc = null;

              snapshot.forEach((doc) => {
                const data = doc.data();
                if (!latestDoc) latestDoc = data;

                temps.fullDates.push(data.created_at);

                const fullTime = data.created_at
                  ? data.created_at.split(" ")[1]
                  : "";
                const shortTime = fullTime.substring(0, 5);

                temps.labels.push(shortTime);
                temps.power.push(data.power);
                temps.voltage.push(data.voltage);
                temps.energy.push(data.energy);

                if (todayStartEnergy !== null) {
                  let val = data.energy - todayStartEnergy;
                  if (val < 0) val = 0;
                  temps.dailyEnergyProfile.push(val.toFixed(4));
                } else {
                  temps.dailyEnergyProfile.push(0);
                }
              });

              window.lastDataTime = new Date();
              cachedData.labels = temps.labels.reverse();
              cachedData.fullDates = temps.fullDates.reverse();
              cachedData.power = temps.power.reverse();
              cachedData.voltage = temps.voltage.reverse();
              cachedData.energy = temps.energy.reverse();
              cachedData.dailyEnergyProfile =
                temps.dailyEnergyProfile.reverse();

              if (latestDoc) {
                document.getElementById("disp-voltage").innerText =
                  latestDoc.voltage;
                document.getElementById("disp-power").innerText =
                  latestDoc.power;
                document.getElementById("disp-energy").innerText =
                  latestDoc.energy;

                if (todayStartEnergy !== null) {
                  let daily = (latestDoc.energy - todayStartEnergy).toFixed(3);
                  if (daily < 0) daily = "0.000";
                  document.getElementById("disp-daily").innerText = daily;
                } else {
                  document.getElementById("disp-daily").innerText = "...";
                  if (!todayStartEnergy) fetchTodayStartEnergy();
                }
              }
              updateChartData();
            },
            (error) => console.error("Error readings:", error)
          );
      }

      function initPowerMonitor(chartType = "line") {
        const ctx = document.getElementById("powerChart").getContext("2d");
        if (powerChart) powerChart.destroy();

        const isDark = document.body.classList.contains("dark");
        const gridColor = isDark ? "#444" : "#eee";
        const textColor = isDark ? "#ccc" : "#666";

        powerChart = new Chart(ctx, {
          type: chartType,
          data: {
            labels: [],
            datasets: [
              {
                label: "Завантаження...",
                data: [],
                borderWidth: chartType === "bar" ? 0 : 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                barPercentage: 0.6,
                categoryPercentage: 0.8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: "index" },
            plugins: {
              legend: { labels: { color: textColor } },
              zoom: {
                pan: { enabled: true, mode: "x" },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x",
                },
              },
            },
            scales: {
              x: { ticks: { color: textColor }, grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: { color: textColor },
                grid: { color: gridColor },
              },
            },
            animation: { duration: 300 },
          },
        });
      }

      setInterval(() => {
        const statusEl = document.getElementById("admin-status");
        if (window.lastDataTime) {
          const diffSeconds = (new Date() - window.lastDataTime) / 1000;
          if (diffSeconds > 75) {
            statusEl.innerHTML =
              '<span style="color:red; font-weight:bold;">⚠️ OFFLINE</span>';
            document.querySelector(".dashboard-wrapper").style.opacity = "0.5";
          } else {
            statusEl.innerHTML = '<span style="color:#28a745;">● ONLINE</span>';
            document.querySelector(".dashboard-wrapper").style.opacity = "1";
          }
        }
      }, 5000);

      function initLogs() {
        db.collection("system_logs")
          .orderBy("created_at", "desc")
          .limit(10)
          .onSnapshot((snapshot) => {
            const tbody = document.getElementById("logs-body");
            tbody.innerHTML = "";
            if (snapshot.empty) {
              tbody.innerHTML =
                "<tr><td colspan='3' style='text-align:center; padding:15px; opacity:0.5;'>Журнал порожній</td></tr>";
              return;
            }
            snapshot.forEach((doc) => {
              const data = doc.data();
              let reasonColor = "inherit";
              let reasonWeight = "normal";
              const r = data.reason || "";
              if (r.includes("Power ON")) {
                reasonColor = "#28a745";
                reasonWeight = "bold";
              }
              if (r.includes("Watchdog") || r.includes("Reset")) {
                reasonColor = "#dc3545";
                reasonWeight = "bold";
              }
              if (r.includes("Brownout")) {
                reasonColor = "#fd7e14";
                reasonWeight = "bold";
              }
              const row = `<tr>
                    <td style="font-family: monospace; opacity: 0.8;">${
                      data.created_at || "---"
                    }</td>
                    <td style="font-weight: 500;">${data.message || "---"}</td>
                    <td style="color: ${reasonColor}; font-weight: ${reasonWeight};">${r}</td>
                </tr>`;
              tbody.innerHTML += row;
            });
          });
      }

      function showUserProfile() {
        console.log("Profile clicked");
      }

      window.addEventListener("DOMContentLoaded", async () => {
        if (localStorage.getItem("theme") === "dark")
          document.body.classList.add("dark");
        await loadComponent("sidebar-placeholder", "sidebar.html");
        if (typeof BUILD_VERSION !== "undefined")
          document.getElementById("buildVersion").textContent = BUILD_VERSION;

        auth.onAuthStateChanged((user) => {
          if (user && db) {
            checkAdminStatus(user);
          } else {
            window.location.replace("auth.html");
          }
        });
      });

      async function checkAdminStatus(user) {
        const userRef = db.collection("users").doc(user.uid);
        try {
          const doc = await userRef.get();
          if (doc.exists && doc.data().role === "admin") {
            isAdmin = true;
            document.getElementById("monitoring-section").style.display =
              "block";
            const username = doc.data().username || user.email;
            document.getElementById("user-email-display").textContent =
              username;
            const adminMenuItem = document.getElementById("admin-menu-item");
            if (adminMenuItem) adminMenuItem.style.display = "block";
            initPowerMonitor();
            initLogs();
          } else {
            window.location.replace("index.html");
          }
        } catch (error) {
          window.location.replace("index.html");
        }
      }
    </script>
  </body>
</html>
