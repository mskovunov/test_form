<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Моніторинг Енергії</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-N0T0138X0Q"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-N0T0138X0Q");
    </script>

    <style>
      /* Карточки показників */
      .dashboard-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
      }

      .info-card {
        background: #fff;
        border: 2px solid transparent;
        border-color: #eee;
        border-radius: 10px;
        padding: 15px;
        flex: 1 1 140px;
        min-width: 130px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Активная карточка */
      .info-card.active-card {
        background-color: #f0f8ff;
        border-color: currentColor; /* Цвет рамки берется от цвета текста */
      }
      .dark .info-card {
        background: #2b2b2b;
        border-color: #444;
      }
      .dark .info-card.active-card {
        background-color: #333;
      }

      .info-card h3 {
        margin: 0 0 10px 0;
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
      }
      .info-card .value {
        font-size: 1.5rem; /* Чуть уменьшил шрифт, чтобы влезло 4 карточки */
        font-weight: bold;
        color: #333;
      }
      .dark .info-card .value {
        color: #eee;
      }

      .info-card .unit {
        font-size: 0.8rem;
        color: #aaa;
        margin-left: 4px;
      }

      /* Контейнер графіка */
      .chart-container {
        background: #fff;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        position: relative;
        height: 350px;
        width: 100%;
      }
      .dark .chart-container {
        background: #2b2b2b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button class="menu-button" onclick="toggleMenu()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4 6H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 12H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M4 18H20"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <div class="form-wrapper">
        <div id="sidebar-placeholder"></div>

        <h2>Моніторинг Енергомережі</h2>
        <p
          id="admin-status"
          style="text-align: center; margin-bottom: 10px; height: 20px"
        ></p>

        <div id="monitoring-section" style="display: none">
          <div class="dashboard-wrapper">
            <div
              class="info-card"
              id="card-voltage"
              onclick="setChartMode('voltage')"
              style="color: #ff9800"
            >
              <h3>Напруга</h3>
              <div class="value" style="color: inherit">
                <span id="disp-voltage">--</span><span class="unit">V</span>
              </div>
            </div>

            <div
              class="info-card active-card"
              id="card-power"
              onclick="setChartMode('power')"
              style="color: #007bff"
            >
              <h3>Потужність</h3>
              <div class="value" style="color: inherit">
                <span id="disp-power">--</span><span class="unit">W</span>
              </div>
            </div>

            <div
              class="info-card"
              id="card-energy"
              onclick="setChartMode('energy')"
              style="color: #6f42c1"
            >
              <h3>Лічильник (Total)</h3>
              <div class="value" style="color: inherit">
                <span id="disp-energy">--</span><span class="unit">kWh</span>
              </div>
            </div>

            <div
              class="info-card"
              id="card-daily"
              onclick="setChartMode('daily')"
              style="color: #28a745"
            >
              <h3>Сьогодні</h3>
              <div class="value" style="color: inherit">
                <span id="disp-daily">--</span><span class="unit">kWh</span>
              </div>
            </div>
          </div>

          <div class="chart-container">
            <canvas id="powerChart"></canvas>
          </div>
        </div>

        <p
          id="buildVersion"
          style="
            margin-top: 20px;
            font-size: 0.75rem;
            color: #999;
            text-align: center;
          "
        ></p>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="./firebase-init.js"></script>
    <script src="utils.js"></script>

    <script>
      let isAdmin = false;
      let powerChart = null;
      let currentMode = "power";

      // Для расчетов "суточного" пробега
      let todayStartEnergy = null;

      // Кеш данных для графиков
      let cachedData = {
        labels: [],
        power: [],
        voltage: [],
        energy: [], // Данные для общего счетчика
        dailyEnergyProfile: [], // Данные для суточного графика
      };

      // Конфигурация цветов для 4 режимов
      const chartConfig = {
        power: {
          label: "Потужність (W)",
          color: "rgb(0, 123, 255)",
          bg: "rgba(0, 123, 255, 0.1)",
        },
        voltage: {
          label: "Напруга (V)",
          color: "rgb(255, 152, 0)",
          bg: "rgba(255, 152, 0, 0.1)",
        },
        energy: {
          label: "Всього накопичено (kWh)",
          color: "rgb(111, 66, 193)",
          bg: "rgba(111, 66, 193, 0.1)",
        }, // Фиолетовый
        daily: {
          label: "Споживання сьогодні (kWh)",
          color: "rgb(40, 167, 69)",
          bg: "rgba(40, 167, 69, 0.1)",
        }, // Зеленый
      };

      // --- ПЕРЕМИКАННЯ РЕЖИМІВ ---
      window.setChartMode = function (mode) {
        currentMode = mode;

        // Убираем активный класс со всех, добавляем нужному
        document
          .querySelectorAll(".info-card")
          .forEach((el) => el.classList.remove("active-card"));
        document.getElementById(`card-${mode}`).classList.add("active-card");

        updateChartData();
      };

      function updateChartData() {
        if (!powerChart) return;
        const cfg = chartConfig[currentMode];

        powerChart.data.datasets[0].label = cfg.label;
        powerChart.data.datasets[0].borderColor = cfg.color;
        powerChart.data.datasets[0].backgroundColor = cfg.bg;

        // Подставляем нужный массив данных
        if (currentMode === "daily") {
          powerChart.data.datasets[0].data = cachedData.dailyEnergyProfile;
        } else {
          powerChart.data.datasets[0].data = cachedData[currentMode];
        }

        // Настройка начала оси Y
        // Для Напряжения (voltage) и Общего счетчика (energy) лучше НЕ начинать с нуля,
        // иначе график будет прямой линией где-то вверху.
        if (currentMode === "voltage" || currentMode === "energy") {
          powerChart.options.scales.y.beginAtZero = false;
        } else {
          powerChart.options.scales.y.beginAtZero = true; // Для Power и Daily лучше с 0
        }

        powerChart.data.labels = cachedData.labels;
        powerChart.update();
      }

      // --- ПОИСК ДАННЫХ НА НАЧАЛО ДНЯ ---
      function fetchTodayStartEnergy() {
        const now = new Date();
        const dateString =
          now.getFullYear() +
          "-" +
          String(now.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(now.getDate()).padStart(2, "0");

        const startOfDayStr = dateString + " 00:00:00";

        db.collection("meter_readings")
          .where("created_at", ">=", startOfDayStr)
          .orderBy("created_at", "asc")
          .limit(1)
          .get()
          .then((snapshot) => {
            if (!snapshot.empty) {
              todayStartEnergy = snapshot.docs[0].data().energy;
              console.log("Start Energy Today:", todayStartEnergy);
            } else {
              todayStartEnergy = null;
            }
          })
          .catch((error) => console.error("Index Error check:", error));
      }

      // --- ГЛАВНАЯ ФУНКЦИЯ ---
      function initPowerMonitor() {
        const ctx = document.getElementById("powerChart").getContext("2d");
        const isDark = document.body.classList.contains("dark");
        const gridColor = isDark ? "#444" : "#eee";
        const textColor = isDark ? "#ccc" : "#666";

        powerChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: chartConfig.power.label,
                data: [],
                borderColor: chartConfig.power.color,
                backgroundColor: chartConfig.power.bg,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: "index" },
            plugins: { legend: { labels: { color: textColor } } },
            scales: {
              x: { ticks: { color: textColor }, grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: { color: textColor },
                grid: { color: gridColor },
              },
            },
            animation: { duration: 0 },
          },
        });

        // Таймер офлайна
        setInterval(() => {
          const statusEl = document.getElementById("admin-status");
          if (window.lastDataTime) {
            const diffSeconds = (new Date() - window.lastDataTime) / 1000;
            if (diffSeconds > 35) {
              statusEl.innerHTML =
                '<span style="color:red; font-weight:bold;">⚠️ OFFLINE</span>';
              document.querySelector(".dashboard-wrapper").style.opacity =
                "0.5";
            } else {
              statusEl.innerHTML =
                '<span style="color:#28a745;">● ONLINE</span>';
              document.querySelector(".dashboard-wrapper").style.opacity = "1";
            }
          }
        }, 5000);

        fetchTodayStartEnergy();

        // Realtime Listener
        db.collection("meter_readings")
          .orderBy("created_at", "desc")
          .limit(100)
          .onSnapshot(
            (snapshot) => {
              const temps = {
                labels: [],
                power: [],
                voltage: [],
                energy: [],
                dailyEnergyProfile: [],
              };
              let latestDoc = null;

              snapshot.forEach((doc) => {
                const data = doc.data();
                if (!latestDoc) latestDoc = data;

                const timePart = data.created_at
                  ? data.created_at.split(" ")[1]
                  : "";

                temps.labels.push(timePart);
                temps.power.push(data.power);
                temps.voltage.push(data.voltage);
                temps.energy.push(data.energy); // Сырые данные для общего графика

                // Расчет для суточного графика
                if (todayStartEnergy !== null) {
                  let val = data.energy - todayStartEnergy;
                  if (val < 0) val = 0;
                  temps.dailyEnergyProfile.push(val.toFixed(4));
                } else {
                  temps.dailyEnergyProfile.push(0);
                }
              });

              window.lastDataTime = new Date();

              cachedData.labels = temps.labels.reverse();
              cachedData.power = temps.power.reverse();
              cachedData.voltage = temps.voltage.reverse();
              cachedData.energy = temps.energy.reverse();
              cachedData.dailyEnergyProfile =
                temps.dailyEnergyProfile.reverse();

              if (latestDoc) {
                document.getElementById("disp-voltage").innerText =
                  latestDoc.voltage;
                document.getElementById("disp-power").innerText =
                  latestDoc.power;
                document.getElementById("disp-energy").innerText =
                  latestDoc.energy;

                // Расчет цифры "Сегодня"
                if (todayStartEnergy !== null) {
                  let daily = (latestDoc.energy - todayStartEnergy).toFixed(3);
                  if (daily < 0) daily = "0.000";
                  document.getElementById("disp-daily").innerText = daily;
                } else {
                  document.getElementById("disp-daily").innerText = "...";
                  // Если старт не найден, пробуем искать снова (вдруг индексы прогрузились)
                  if (!todayStartEnergy) fetchTodayStartEnergy();
                }
              }

              updateChartData();
            },
            (error) => {
              console.error("Error getting meter readings:", error);
            }
          );
      }

      window.addEventListener("DOMContentLoaded", async () => {
        if (localStorage.getItem("theme") === "dark")
          document.body.classList.add("dark");
        await loadComponent("sidebar-placeholder", "sidebar.html");
        if (typeof BUILD_VERSION !== "undefined")
          document.getElementById("buildVersion").textContent = BUILD_VERSION;

        auth.onAuthStateChanged((user) => {
          if (user && db) {
            checkAdminStatus(user);
          } else {
            window.location.replace("auth.html");
          }
        });
      });

      async function checkAdminStatus(user) {
        const userRef = db.collection("users").doc(user.uid);
        try {
          const doc = await userRef.get();
          if (doc.exists && doc.data().role === "admin") {
            isAdmin = true;
            document.getElementById("monitoring-section").style.display =
              "block";
            initPowerMonitor();
          } else {
            window.location.replace("index.html");
          }
        } catch (error) {
          window.location.replace("index.html");
        }
      }
    </script>
  </body>
</html>
